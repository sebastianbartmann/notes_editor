<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Files</title>
    <link rel="stylesheet" href="/static/style.css?v=2025-01-01">
    <script src="/static/htmx.min.js?v=2025-01-01"></script>
</head>
<body>
    <main class="container">
        <nav class="topbar">
            <div class="brand">
                <strong>Files</strong>
                <a class="button ghost" href="/">Daily</a>
                <a class="button ghost" href="/tools">Tools</a>
            </div>
            <div class="today">Person: {{ person }}</div>
        </nav>

        <article class="panel files-panel">
            <section class="tree-panel">
                <div class="panel-header">
                    <h3>Vault</h3>
                </div>
                <form class="file-create" hx-post="/api/files/create" hx-target="#file-message" hx-swap="innerHTML">
                    <input type="text" name="path" placeholder="new/file.md" required autocomplete="off" spellcheck="false">
                    <button type="submit" class="button">Create</button>
                </form>
                <div id="file-message"></div>
                <div id="tree-root" class="file-tree">
                    {{ tree_html | safe }}
                </div>
            </section>
        </article>
    </main>

    <script>
        document.body.addEventListener('click', function(event) {
            const toggle = event.target.closest('.tree-toggle');
            if (!toggle) {
                const dirRow = event.target.closest('.tree-item.dir');
                if (!dirRow) {
                    return;
                }
                const rowToggle = dirRow.querySelector('.tree-toggle');
                if (rowToggle) {
                    rowToggle.click();
                }
                return;
            }

            const targetId = toggle.getAttribute('data-target');
            const target = document.getElementById(targetId);
            if (!target) {
                return;
            }

            if (target.dataset.loaded === 'true') {
                const isHidden = target.style.display === 'none';
                target.style.display = isHidden ? 'block' : 'none';
                toggle.textContent = isHidden ? '-' : '+';
            } else {
                toggle.textContent = '-';
            }
        });

        document.body.addEventListener('htmx:beforeRequest', function(evt) {
            const toggle = evt.detail.elt;
            if (!toggle || !toggle.classList || !toggle.classList.contains('tree-toggle')) {
                return;
            }

            const targetId = toggle.getAttribute('data-target');
            const target = document.getElementById(targetId);
            if (target && target.dataset.loaded === 'true') {
                evt.preventDefault();
            }
        });

        document.body.addEventListener('htmx:afterSwap', function(evt) {
            const toggle = evt.detail.requestConfig?.elt;
            if (toggle && toggle.classList && toggle.classList.contains('tree-toggle')) {
                const targetId = toggle.getAttribute('data-target');
                const target = document.getElementById(targetId);
                if (target) {
                    target.dataset.loaded = 'true';
                    target.style.display = 'block';
                }
            }
        });

        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.xhr.responseURL.includes('/api/files/create')) {
                const messageDiv = document.getElementById('file-message');
                if (evt.detail.successful) {
                    const response = JSON.parse(evt.detail.xhr.response);
                    messageDiv.innerHTML = `<mark>${response.message}</mark>`;
                    htmx.ajax('GET', '/api/files/tree?path=.', {
                        target: '#tree-root',
                        swap: 'innerHTML'
                    });
                } else {
                    messageDiv.innerHTML = `<mark class="error">Error creating file</mark>`;
                }
            }
        });
    </script>
</body>
</html>
