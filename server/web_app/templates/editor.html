<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Notes</title>

    <link rel="stylesheet" href="/static/style.css?v=2025-01-01">
    <script src="/static/htmx.min.js?v=2025-01-01"></script>
</head>
<body class="{{ theme_class }}">
    <main class="container">
        <nav class="topbar">
            <div class="brand">
                <strong>Daily Notes</strong>
                <button onclick="location.reload()" class="button ghost">Reload</button>
                <a class="button ghost" href="/tools">Tools</a>
            </div>
            <div class="today">Person: {{ person }} Â· Today: {{ today }}</div>
        </nav>

        <article class="panel">
            <div id="current-content">
                <div class="panel-header">
                    <h3>Current Note</h3>
                </div>
                <div id="note-display" class="note-view">{{ note_html | safe }}</div>
                <div class="actions view-actions" id="view-actions">
                    <button id="edit-btn" class="button" onclick="toggleEditMode()">Edit</button>
                    <form class="inline-form" hx-post="/api/todos/add" hx-target="#message" hx-swap="innerHTML">
                        <input type="hidden" name="category" value="work">
                        <button type="submit" class="button ghost">Work task</button>
                    </form>
                    <form class="inline-form" hx-post="/api/todos/add" hx-target="#message" hx-swap="innerHTML">
                        <input type="hidden" name="category" value="priv">
                        <button type="submit" class="button ghost">Priv task</button>
                    </form>
                </div>
                <form id="edit-form" class="edit-form" style="display: none;" hx-post="/api/save" hx-target="#save-message" hx-swap="innerHTML">
                    <textarea id="note-editor" name="content" rows="20">{{ content }}</textarea>
                    <div class="actions view-actions">
                        <button type="submit" class="button">Save</button>
                        <button type="button" class="button ghost" onclick="cancelEdit()">Cancel</button>
                    </div>
                </form>
                <div id="save-message"></div>
            </div>

            <hr>

            <form hx-post="/api/append"
                  hx-target="#message"
                  hx-swap="innerHTML"
                  hx-on::after-request="if(event.detail.successful) { document.getElementById('content').value = ''; location.reload(); }">

                <div class="form-row">
                    <button type="button" class="button ghost" onclick="clearPinned()">Clear</button>
                    <div class="pin-row">
                        <input type="checkbox" id="pinned" name="pinned">
                        <label for="pinned">Pin</label>
                    </div>
                    <button type="submit" class="button">Add</button>
                </div>
                <textarea
                    id="content"
                    name="content"
                    rows="8"
                    placeholder="Write something..."
                    required></textarea>
            </form>

            <div id="message"></div>
        </article>
    </main>

    <script>
        function toggleEditMode() {
            document.getElementById('note-display').style.display = 'none';
            document.getElementById('edit-form').style.display = 'block';
            document.getElementById('edit-btn').style.display = 'none';
            document.getElementById('view-actions').style.display = 'none';
        }

        function cancelEdit() {
            document.getElementById('note-display').style.display = 'block';
            document.getElementById('edit-form').style.display = 'none';
            document.getElementById('edit-btn').style.display = 'inline-block';
            document.getElementById('view-actions').style.display = 'flex';
            document.getElementById('save-message').innerHTML = '';
        }

        async function clearPinned() {
            const response = await fetch('/api/clear-pinned', { method: 'POST' });
            const data = await response.json();
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<mark>${data.message}</mark>`;
            setTimeout(() => location.reload(), 1000);
        }

        // Handle append response
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.xhr.responseURL.includes('/api/append')) {
                const messageDiv = document.getElementById('message');
                if (evt.detail.successful) {
                    const response = JSON.parse(evt.detail.xhr.response);
                    messageDiv.innerHTML = `<mark>${response.message}</mark>`;

                    // Clear message after 3 seconds
                    setTimeout(() => {
                        messageDiv.innerHTML = '';
                    }, 3000);
                } else {
                    messageDiv.innerHTML = `<mark style="background-color: var(--pico-del-color);">Error appending content</mark>`;
                }
            }
        });

        // Handle unpin response
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.xhr.responseURL.includes('/api/files/unpin')) {
                const messageDiv = document.getElementById('message');
                if (evt.detail.successful) {
                    const response = JSON.parse(evt.detail.xhr.response);
                    messageDiv.innerHTML = `<mark>${response.message}</mark>`;
                    setTimeout(() => {
                        location.reload();
                    }, 600);
                } else {
                    messageDiv.innerHTML = `<mark class="error">Error unpinning</mark>`;
                }
            }
        });

        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.xhr.responseURL.includes('/api/todos/add')) {
                const messageDiv = document.getElementById('message');
                if (evt.detail.successful) {
                    const response = JSON.parse(evt.detail.xhr.response);
                    messageDiv.innerHTML = `<mark>${response.message}</mark>`;
                    sessionStorage.setItem('openEditAfterReload', 'true');
                    setTimeout(() => {
                        location.reload();
                    }, 300);
                } else {
                    messageDiv.innerHTML = `<mark class="error">Error adding task</mark>`;
                }
            }
        });

        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.xhr.responseURL.includes('/api/todos/toggle')) {
                const messageDiv = document.getElementById('message');
                if (evt.detail.successful) {
                    const response = JSON.parse(evt.detail.xhr.response);
                    messageDiv.innerHTML = `<mark>${response.message}</mark>`;
                    setTimeout(() => {
                        location.reload();
                    }, 400);
                } else {
                    messageDiv.innerHTML = `<mark class="error">Error updating task</mark>`;
                }
            }
        });

        // Handle save response
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.xhr.responseURL.includes('/api/save')) {
                const saveMessageDiv = document.getElementById('save-message');
                if (evt.detail.successful) {
                    const response = JSON.parse(evt.detail.xhr.response);
                    saveMessageDiv.innerHTML = `<mark>${response.message}</mark>`;

                    // Reload page after 1 second to show updated content
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    saveMessageDiv.innerHTML = `<mark style="background-color: var(--pico-del-color);">Error saving note</mark>`;
                }
            }
        });

        if (sessionStorage.getItem('openEditAfterReload') === 'true') {
            sessionStorage.removeItem('openEditAfterReload');
            toggleEditMode();
        }
    </script>
</body>
</html>
