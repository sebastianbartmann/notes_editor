<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleep Times</title>
    <link rel="stylesheet" href="/static/style.css?v=2025-01-01">
    <script src="/static/htmx.min.js?v=2025-01-01"></script>
</head>
<body class="{{ theme_class }}">
    <main class="container">
        <nav class="topbar">
            <div class="brand">
                <strong>Sleep Times</strong>
                <button onclick="location.reload()" class="button ghost">Reload</button>
                <a class="button ghost" href="/tools">Tools</a>
            </div>
            <div class="today">Person: {{ person }}</div>
        </nav>

        <article class="panel">
            <form class="sleep-form" hx-post="/api/sleep-times/append" hx-target="#sleep-message" hx-swap="innerHTML">
                <div class="panel-header">
                    <h3>Log</h3>
                </div>
                <div class="sleep-grid">
                    <label class="sleep-choice">
                        <input type="radio" name="child" value="Thomas">
                        <span>Thomas</span>
                    </label>
                    <label class="sleep-choice">
                        <input type="radio" name="child" value="Fabian" checked>
                        <span>Fabian</span>
                    </label>
                    <label class="sleep-choice">
                        <input type="checkbox" id="status-asleep" name="asleep">
                        <span>eingeschlafen</span>
                    </label>
                    <label class="sleep-choice">
                        <input type="checkbox" id="status-woke" name="woke">
                        <span>aufgewacht</span>
                    </label>
                </div>
                <input type="text" id="sleep-entry" name="entry" placeholder="Entry (19:30-06:10 | night)" required autocomplete="off" autocapitalize="none" spellcheck="false">
                <div class="actions view-actions">
                    <button class="button" type="submit">Add</button>
                </div>
            </form>
            <div id="sleep-message"></div>

            <div class="sleep-history">
                <div class="panel-header">
                    <h3>Recent</h3>
                </div>
                <div class="sleep-list">
                    {% if entries %}
                        {% for item in entries %}
                        <div class="sleep-line">
                            <span>{{ item.text }}</span>
                            <form class="inline-form" hx-post="/api/sleep-times/delete" hx-target="#sleep-message" hx-swap="innerHTML">
                                <input type="hidden" name="line" value="{{ item.line_no }}">
                                <button type="submit" class="button ghost danger">Delete</button>
                            </form>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="muted">No entries yet.</p>
                    {% endif %}
                </div>
            </div>
        </article>
    </main>

    <script>
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.xhr.responseURL.includes('/api/sleep-times/append')) {
                const messageDiv = document.getElementById('sleep-message');
                if (evt.detail.successful) {
                    const response = JSON.parse(evt.detail.xhr.response);
                    messageDiv.innerHTML = `<mark>${response.message}</mark>`;
                    setTimeout(() => {
                        location.reload();
                    }, 600);
                } else {
                    messageDiv.innerHTML = `<mark class="error">Error adding entry</mark>`;
                }
            }
        });

        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.xhr.responseURL.includes('/api/sleep-times/delete')) {
                const messageDiv = document.getElementById('sleep-message');
                if (evt.detail.successful) {
                    const response = JSON.parse(evt.detail.xhr.response);
                    messageDiv.innerHTML = `<mark>${response.message}</mark>`;
                    setTimeout(() => {
                        location.reload();
                    }, 400);
                } else {
                    messageDiv.innerHTML = `<mark class="error">Error deleting entry</mark>`;
                }
            }
        });

        const asleepCheckbox = document.getElementById('status-asleep');
        const wokeCheckbox = document.getElementById('status-woke');
        if (asleepCheckbox && wokeCheckbox) {
            asleepCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    wokeCheckbox.checked = false;
                }
            });
            wokeCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    asleepCheckbox.checked = false;
                }
            });
        }

    </script>
</body>
</html>
