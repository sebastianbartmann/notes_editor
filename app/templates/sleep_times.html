<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleep Times</title>
    <link rel="stylesheet" href="/static/style.css?v=2025-01-01">
    <script src="/static/htmx.min.js?v=2025-01-01"></script>
</head>
<body class="theme-petra">
    <main class="container">
        <nav class="topbar">
            <div class="brand">
                <strong>Sleep Times</strong>
                <a class="button ghost" href="/petra">Petra Notes</a>
                <button class="button ghost" type="button" id="theme-toggle">Night</button>
            </div>
        </nav>

        <article class="panel">
            <div class="panel-header">
                <h3>Log</h3>
            </div>
            <form class="sleep-form" hx-post="/api/sleep-times/append" hx-target="#sleep-message" hx-swap="innerHTML">
                <div class="sleep-inputs">
                    <div class="sleep-block">
                        <span class="sleep-label">Child</span>
                        <div class="sleep-row">
                            <div class="sleep-options">
                                <label class="sleep-choice">
                                    <input type="radio" name="child" value="Fabian" checked>
                                    <span>Fabian</span>
                                </label>
                                <label class="sleep-choice">
                                    <input type="radio" name="child" value="Thomas">
                                    <span>Thomas</span>
                                </label>
                            </div>
                            <span class="sleep-divider"></span>
                            <div class="sleep-status">
                                <label class="sleep-choice">
                                    <input type="checkbox" id="status-asleep" name="asleep">
                                    <span>eingeschlafen</span>
                                </label>
                                <label class="sleep-choice">
                                    <input type="checkbox" id="status-woke" name="woke">
                                    <span>aufgewacht</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="sleep-block sleep-entry">
                        <span class="sleep-label">Entry</span>
                        <div class="sleep-entry-row">
                            <input type="text" id="sleep-entry" name="entry" placeholder="19:30-06:10 night" required autocomplete="off" autocapitalize="none" spellcheck="false">
                            <div class="sleep-time-pickers">
                                <div class="sleep-time-fields">
                                    <select id="sleep-hour" aria-label="Hour">
                                        <option value="">HH</option>
                                        {% for h in range(0, 24) %}
                                        <option value="{{ '%02d' % h }}">{{ '%02d' % h }}</option>
                                        {% endfor %}
                                    </select>
                                    <span class="sleep-time-colon">:</span>
                                    <select id="sleep-minute" aria-label="Minute">
                                        <option value="">MM</option>
                                        {% for m in range(0, 60) %}
                                        <option value="{{ '%02d' % m }}">{{ '%02d' % m }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="button" class="button ghost" id="sleep-time-add">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="actions view-actions">
                    <button class="button" type="submit">Add</button>
                </div>
            </form>
            <div id="sleep-message"></div>

            <div class="sleep-history">
                <div class="panel-header">
                    <h3>Recent</h3>
                </div>
                <div class="sleep-list">
                    {% if entries %}
                        {% for item in entries %}
                        <div class="sleep-line">
                            <span>{{ item.text }}</span>
                            <form class="inline-form" hx-post="/api/sleep-times/delete" hx-target="#sleep-message" hx-swap="innerHTML">
                                <input type="hidden" name="line" value="{{ item.line_no }}">
                                <button type="submit" class="button ghost danger">Delete</button>
                            </form>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="muted">No entries yet.</p>
                    {% endif %}
                </div>
            </div>
        </article>
    </main>

    <script>
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.xhr.responseURL.includes('/api/sleep-times/append')) {
                const messageDiv = document.getElementById('sleep-message');
                if (evt.detail.successful) {
                    const response = JSON.parse(evt.detail.xhr.response);
                    messageDiv.innerHTML = `<mark>${response.message}</mark>`;
                    setTimeout(() => {
                        location.reload();
                    }, 600);
                } else {
                    messageDiv.innerHTML = `<mark class="error">Error adding entry</mark>`;
                }
            }
        });

        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.xhr.responseURL.includes('/api/sleep-times/delete')) {
                const messageDiv = document.getElementById('sleep-message');
                if (evt.detail.successful) {
                    const response = JSON.parse(evt.detail.xhr.response);
                    messageDiv.innerHTML = `<mark>${response.message}</mark>`;
                    setTimeout(() => {
                        location.reload();
                    }, 400);
                } else {
                    messageDiv.innerHTML = `<mark class="error">Error deleting entry</mark>`;
                }
            }
        });

        const asleepCheckbox = document.getElementById('status-asleep');
        const wokeCheckbox = document.getElementById('status-woke');
        if (asleepCheckbox && wokeCheckbox) {
            asleepCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    wokeCheckbox.checked = false;
                }
            });
            wokeCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    asleepCheckbox.checked = false;
                }
            });
        }

        const sleepEntry = document.getElementById('sleep-entry');
        const sleepHour = document.getElementById('sleep-hour');
        const sleepMinute = document.getElementById('sleep-minute');
        const sleepAdd = document.getElementById('sleep-time-add');

        function addSleepTime() {
            if (!sleepEntry || !sleepHour || !sleepMinute) {
                return;
            }
            if (!sleepHour.value || !sleepMinute.value) {
                return;
            }
            const time = `${sleepHour.value}:${sleepMinute.value}`;
            const value = sleepEntry.value.trim();
            if (!value) {
                sleepEntry.value = time;
                return;
            }

            const matches = value.match(/\b\d{2}:\d{2}\b/g) || [];
            if (matches.length === 1 && !value.includes("-") && value.endsWith(matches[0])) {
                sleepEntry.value = `${value}-${time}`;
            } else {
                sleepEntry.value = `${value} ${time}`;
            }
        }

        if (sleepAdd) {
            sleepAdd.addEventListener('click', addSleepTime);
        }

        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const stored = localStorage.getItem('sleep-theme');
            const useDark = stored ? stored === 'dark' : prefersDark;
            if (useDark) {
                document.body.classList.remove('theme-petra');
                themeToggle.textContent = 'Day';
            }

            themeToggle.addEventListener('click', function() {
                const isPetra = document.body.classList.contains('theme-petra');
                if (isPetra) {
                    document.body.classList.remove('theme-petra');
                    localStorage.setItem('sleep-theme', 'dark');
                    themeToggle.textContent = 'Day';
                } else {
                    document.body.classList.add('theme-petra');
                    localStorage.setItem('sleep-theme', 'light');
                    themeToggle.textContent = 'Night';
                }
            });
        }
    </script>
</body>
</html>
